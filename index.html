<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ§§ 2026 é˜¿åœŸä¼¯ (ç²¾ç°¡ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap');
        
        :root {
            --primary-red: #cc0000;
            --dark-gold: #b38600;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fffaf0;
            color: #1a1a1a;
            margin: 0;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
        }

        /* é–å®šç•«é¢æ¨£å¼ */
        #authBarrier {
            position: fixed;
            inset: 0;
            background: #cc0000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .festive-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 3px solid #ff0000;
        }

        .btn-large {
            background-color: var(--primary-red);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 900;
            text-align: center;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 0 #800000;
            display: block;
            width: 100%;
        }

        .btn-gold-large {
            background-color: #ffcc00;
            color: #332200;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 900;
            text-align: center;
            border: 2px solid #b38600;
            box-shadow: 0 4px 0 #b38600;
            display: block;
            width: 100%;
        }

        .calendar-day {
            aspect-ratio: 1.1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 700;
            background: #fdfdfd;
            border: 2px solid #eee;
        }

        .calendar-day.selected {
            background: var(--primary-red);
            color: white;
            border-color: #800000;
        }

        .calendar-day.has-data::after {
            content: 'â—';
            color: #ffcc00;
            position: absolute;
            bottom: 2px;
            font-size: 14px;
        }

        input, select {
            border: 3px solid #cccccc;
            border-radius: 10px;
            padding: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            width: 100%;
            background: white;
        }
        input:focus { border-color: var(--primary-red); }

        .big-label {
            font-size: 1.1rem;
            font-weight: 900;
            color: #333;
            margin-bottom: 6px;
            display: block;
        }

        #importInput { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- èº«åˆ†é©—è­‰é–å®šç•«é¢ -->
    <div id="authBarrier">
        <div class="festive-card p-8 max-w-sm w-full text-center">
            <h2 class="text-3xl font-black text-red-700 mb-6">é˜¿åœŸä¼¯ æ¸¬è©¦å…¥å£</h2>
            <div id="ipChecking" class="mb-4 text-gray-500 font-bold">æ­£åœ¨å®‰å…¨æƒæ...</div>
            <div id="authForm" class="hidden">
                <p class="text-lg font-bold mb-4 text-gray-600">è«‹è¼¸å…¥é€šé—œå¯†ç¢¼</p>
                <input type="password" id="adminPass" class="mb-6 text-center tracking-widest" placeholder="åœ¨æ­¤è¼¸å…¥å¯†ç¢¼">
                <button onclick="checkAuth()" class="btn-large">é©—è­‰èº«åˆ†</button>
                <p id="authError" class="mt-4 text-red-600 font-bold hidden">å¯†ç¢¼ä¸å°å–”ï¼Œå†è©¦ä¸€æ¬¡ï¼</p>
            </div>
            <div id="ipDenied" class="hidden">
                <p class="text-xl font-black text-red-600 mb-4">ğŸš« å­˜å–å—é™</p>
                <p class="text-gray-500 font-bold">æ‚¨çš„ IP ä¸åœ¨å…è¨±æ¸…å–®å…§</p>
                <p id="userIpDisplay" class="mt-2 text-sm text-gray-400"></p>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ (åˆå§‹éš±è—) -->
    <div id="mainContent" class="hidden">
        <div class="max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-5xl font-black text-red-700 mb-2">ğŸ§§ 2026 é˜¿åœŸä¼¯</h1>
                <p class="text-lg text-red-500 font-bold">å­—é«”åŠ å¤§ãƒ»ç°¡å–®å¥½ç”¨</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <!-- Left -->
                <div class="md:col-span-5 space-y-8">
                    <div class="festive-card p-6">
                        <h2 class="text-xl font-black text-center mb-4 text-red-800">ç¬¬ä¸€æ­¥ï¼šé¸æ—¥æœŸ</h2>
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="changeMonth(-1)" class="bg-gray-200 p-4 rounded-full text-2xl font-black">â®</button>
                            <h2 id="currentMonthDisplay" class="text-2xl font-black">2026å¹´ 1æœˆ</h2>
                            <button onclick="changeMonth(1)" class="bg-gray-200 p-4 rounded-full text-2xl font-black">â¯</button>
                        </div>
                        <div class="grid grid-cols-7 gap-3 text-center text-sm font-black text-red-600 mb-2">
                            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-3"></div>
                    </div>

                    <div class="festive-card p-6">
                        <h3 class="text-2xl font-black mb-4 flex items-center text-red-700 border-b-4 border-red-100 pb-2">
                            ğŸ† ç¸½æ’è¡Œæ¦œ
                        </h3>
                        <div id="overallStatsList" class="space-y-3">
                            <p class="text-center text-gray-500 py-4">ç›®å‰é‚„æ²’é–‹å§‹æ¯”è³½å–”ï¼</p>
                        </div>
                    </div>

                    <div class="festive-card p-6 space-y-4">
                        <h3 class="text-xl font-black text-center mb-2">ğŸ’¾ è³‡æ–™å‚™ä»½</h3>
                        <button onclick="exportToCSV()" class="btn-gold-large">æŠŠè³‡æ–™å­˜åˆ°æ‰‹æ©Ÿ (CSV)</button>
                        <button onclick="document.getElementById('importInput').click()" class="text-lg font-bold w-full p-4 border-2 border-dashed border-gray-400 rounded-xl text-gray-600">è®€å–èˆŠè³‡æ–™</button>
                        <input type="file" id="importInput" accept=".csv" onchange="importFromCSV(event)">
                    </div>
                </div>

                <!-- Right -->
                <div class="md:col-span-7">
                    <div class="festive-card p-6 md:p-8">
                        <div class="flex justify-between items-center mb-8 border-b-8 border-red-50 pb-6">
                            <div>
                                <span class="text-lg font-bold text-gray-500">æ­£åœ¨è¼¸å…¥æ—¥æœŸï¼š</span>
                                <h2 class="text-4xl font-black text-red-600" id="selectedDateDisplay">2026-01-01</h2>
                            </div>
                            <div id="balanceBadge" class="p-3 rounded-xl text-lg font-black bg-gray-200 text-gray-600">
                                æœªç®—å¸³
                            </div>
                        </div>

                        <!-- åƒ…ä¿ç•™è²¡ä½é¸æ“‡ -->
                        <div class="mb-8">
                            <label class="big-label">ğŸ§§ æœ¬æ¬¡å¹¸é‹è²¡ä½</label>
                            <select id="fortunePosition">
                                <option value="">--- è«‹é¸æ“‡ä»Šæ—¥è²¡ä½ ---</option>
                                <option value="å®¢å»³ä½">å®¢å»³ä½</option>
                                <option value="é çª—æˆ¶">é çª—æˆ¶</option>
                                <option value="é›»è¦–ä½">é›»è¦–ä½</option>
                                <option value="æ²™ç™¼ä½">æ²™ç™¼ä½</option>
                            </select>
                        </div>

                        <div class="mb-8">
                            <h3 class="big-label border-l-8 border-red-600 pl-3 mb-4">ç¬¬äºŒæ­¥ï¼šå¡«å…¥åˆ†æ•¸</h3>
                            <div class="overflow-hidden border-2 border-gray-100 rounded-xl">
                                <table class="w-full text-left">
                                    <thead class="bg-red-50">
                                        <tr class="text-lg font-black">
                                            <th class="p-4">ç©å®¶å§“å</th>
                                            <th class="p-4 text-center">åˆ†æ•¸ç¸½è¨ˆ</th>
                                            <th class="p-4 text-right">ç›®å‰å°è¨ˆ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="playerTableBody" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="text-lg text-red-600 font-black text-center" id="errorMsg">
                                â€» åˆ†æ•¸å¹³è¡¡å¾Œæ‰èƒ½å­˜æª”å–”ï¼
                            </div>
                            <button id="saveBtn" onclick="saveData()" class="btn-large">
                                ğŸ€„ ç¢ºèªå­˜æª” (ç™¼è²¡å•¦ï¼)
                            </button>
                            <button onclick="clearForm()" class="text-lg font-bold text-gray-400 w-full py-4 underline">
                                æ¸…é™¤æœ¬æ—¥ç´€éŒ„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 px-10 py-6 rounded-2xl bg-black/90 text-white text-2xl font-black opacity-0 transition-opacity pointer-events-none z-50 shadow-2xl"></div>

    <script>
        // è¨­å®šå…è¨±çš„ IP æ¸…å–®
        const ALLOWED_IPS = ["1.2.3.4", "127.0.0.1", "::1"]; 
        const SECRET_KEY = "8888"; 

        async function checkIP() {
            const checkingEl = document.getElementById('ipChecking');
            const authForm = document.getElementById('authForm');
            const ipDenied = document.getElementById('ipDenied');
            const userIpDisplay = document.getElementById('userIpDisplay');

            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                const userIp = data.ip;
                checkingEl.classList.add('hidden');
                if (ALLOWED_IPS.includes(userIp)) {
                    authForm.classList.remove('hidden');
                } else {
                    ipDenied.classList.remove('hidden');
                    userIpDisplay.innerText = `IP: ${userIp}`;
                }
            } catch (error) {
                checkingEl.innerText = "ç„¡æ³•ç¢ºèªç¶²è·¯ç’°å¢ƒï¼Œè«‹æ‰‹å‹•ç™»å…¥";
                authForm.classList.remove('hidden');
            }
        }

        function checkAuth() {
            const input = document.getElementById('adminPass').value;
            const error = document.getElementById('authError');
            if (input === SECRET_KEY) {
                document.getElementById('authBarrier').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');
                init();
                sessionStorage.setItem('mahjong_authed', 'true');
            } else {
                error.classList.remove('hidden');
            }
        }

        window.onload = () => {
            if (sessionStorage.getItem('mahjong_authed') === 'true') {
                document.getElementById('authBarrier').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');
                init();
            } else {
                checkIP();
            }
        };

        let currentYear = 2026;
        let currentMonth = 0;
        let selectedDate = "2026-01-01";
        const FIXED_PLAYERS = ["ç‹å“¡å¤–", "æ—å¤§å”", "è‘‰å¤§å¸«", "è«è‰", "YaYa"];
        let mahjongData = JSON.parse(localStorage.getItem('mahjong_2026_elderly')) || {};

        function init() {
            renderPlayerRows();
            renderCalendar();
            selectDate(selectedDate);
            updateOverallStats();
            setupInputListeners();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('opacity-100');
            setTimeout(() => toast.classList.remove('opacity-100'), 1500);
        }

        function renderPlayerRows() {
            const tbody = document.getElementById('playerTableBody');
            tbody.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const name = FIXED_PLAYERS[i] || "å…¶ä»–";
                tbody.innerHTML += `
                    <tr>
                        <td class="p-4">
                            <input type="text" class="player-name font-black border-none bg-transparent text-xl" value="${name}">
                        </td>
                        <td class="p-4">
                            <input type="number" class="net-input text-center text-2xl font-black w-full" placeholder="0">
                        </td>
                        <td class="p-4 text-right text-2xl font-black row-total text-gray-300">0</td>
                    </tr>
                `;
            }
        }

        function setupInputListeners() {
            document.querySelectorAll('.net-input').forEach(input => {
                input.addEventListener('input', calculateDailyTotal);
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const display = document.getElementById('currentMonthDisplay');
            if (!grid) return;
            grid.innerHTML = '';
            const date = new Date(currentYear, currentMonth, 1);
            display.innerText = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
            const firstDay = date.getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isSelected = dateStr === selectedDate;
                const hasData = mahjongData[dateStr] ? 'has-data' : '';
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day ${isSelected ? 'selected' : ''} ${hasData}`;
                dayEl.innerText = day;
                dayEl.onclick = () => selectDate(dateStr);
                grid.appendChild(dayEl);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            document.getElementById('selectedDateDisplay').innerText = dateStr;
            renderCalendar();
            const rows = document.querySelectorAll('#playerTableBody tr');
            
            if (mahjongData[dateStr]) {
                const data = mahjongData[dateStr];
                document.getElementById('fortunePosition').value = data.fortunePosition || "";
                data.players.forEach((p, i) => {
                    if (rows[i]) {
                        rows[i].querySelector('.player-name').value = p.name;
                        rows[i].querySelector('.net-input').value = (p.win - p.loss) || 0;
                    }
                });
            } else {
                document.querySelectorAll('.net-input').forEach(i => i.value = "");
                document.getElementById('fortunePosition').value = '';
                rows.forEach((row, i) => {
                    row.querySelector('.player-name').value = FIXED_PLAYERS[i] || "å…¶ä»–";
                });
            }
            calculateDailyTotal();
        }

        function calculateDailyTotal() {
            const rows = document.querySelectorAll('#playerTableBody tr');
            let grandTotal = 0;
            rows.forEach(row => {
                const val = parseInt(row.querySelector('.net-input').value) || 0;
                const el = row.querySelector('.row-total');
                el.innerText = (val >= 0 ? '+' : '') + val;
                el.className = `p-4 text-right text-2xl font-black row-total ${val > 0 ? 'text-green-600' : (val < 0 ? 'text-red-600' : 'text-gray-300')}`;
                grandTotal += val;
            });
            const badge = document.getElementById('balanceBadge');
            if (grandTotal === 0) {
                badge.innerText = "âœ… å¸³ç›®æ­£ç¢º";
                badge.className = "p-3 rounded-xl text-lg font-black bg-green-500 text-white shadow-lg animate-bounce";
            } else {
                badge.innerText = `âŒ å·®äº† ${grandTotal}`;
                badge.className = "p-3 rounded-xl text-lg font-black bg-red-100 text-red-600";
            }
        }

        function saveData() {
            const fortune = document.getElementById('fortunePosition').value;
            if (!fortune) { showToast("è«‹é¸ä¸€å€‹è²¡ä½ï¼"); return; }
            
            const rows = document.querySelectorAll('#playerTableBody tr');
            let grandTotal = 0;
            const players = [];
            rows.forEach(row => {
                const name = row.querySelector('.player-name').value;
                const val = parseInt(row.querySelector('.net-input').value) || 0;
                players.push({ name, win: val > 0 ? val : 0, loss: val < 0 ? Math.abs(val) : 0 });
                grandTotal += val;
            });

            if (grandTotal !== 0) { showToast("åˆ†æ•¸ä¸å°å–”ï¼Œå†æª¢æŸ¥ä¸€ä¸‹ï¼"); return; }
            
            mahjongData[selectedDate] = {
                fortunePosition: fortune,
                players: players
            };
            localStorage.setItem('mahjong_2026_elderly', JSON.stringify(mahjongData));
            updateOverallStats();
            renderCalendar();
            showToast("ğŸ§§ å­˜å¥½äº†ï¼æ­å–œç™¼è²¡ï¼");
        }

        function clearForm() {
            if(confirm("ç¢ºå®šè¦åˆªæ‰é€™å¤©çš„ç´€éŒ„å—ï¼Ÿ")) {
                delete mahjongData[selectedDate];
                localStorage.setItem('mahjong_2026_elderly', JSON.stringify(mahjongData));
                selectDate(selectedDate);
                updateOverallStats();
                showToast("å·²åˆªé™¤");
            }
        }

        function updateOverallStats() {
            const totals = {};
            Object.values(mahjongData).forEach(day => {
                day.players.forEach(p => {
                    if (!totals[p.name]) totals[p.name] = { net: 0 };
                    totals[p.name].net += (p.win - p.loss);
                });
            });
            const sorted = Object.entries(totals).sort((a, b) => b[1].net - a[1].net);
            const list = document.getElementById('overallStatsList');
            if (!list) return;
            if (sorted.length === 0) { list.innerHTML = '<p class="text-center text-gray-500 py-4">ç›®å‰é‚„æ²’é–‹å§‹æ¯”è³½å–”ï¼</p>'; return; }
            list.innerHTML = sorted.map(([name, data], index) => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border-2 border-gray-200">
                    <div class="flex items-center gap-4">
                        <span class="text-xl w-8 h-8 flex items-center justify-center rounded-full ${index === 0 ? 'bg-yellow-400 text-white' : 'bg-gray-200 text-gray-500'} font-black">${index+1}</span>
                        <span class="text-2xl font-black">${name}</span>
                    </div>
                    <div class="font-black text-2xl ${data.net >= 0 ? 'text-green-600' : 'text-red-600'}">${data.net >= 0 ? '+' : ''}${data.net}</div>
                </div>
            `).join('');
        }

        function exportToCSV() {
            if (Object.keys(mahjongData).length === 0) { showToast("é‚„æ²’æœ‰è³‡æ–™å¯ä»¥å­˜å–”"); return; }
            let csvContent = "\ufeffæ—¥æœŸ,è²¡ä½,ç©å®¶,åˆ†æ•¸\n";
            Object.keys(mahjongData).sort().forEach(date => {
                const d = mahjongData[date];
                d.players.forEach(p => {
                    csvContent += `${date},${d.fortunePosition},${p.name},${p.win - p.loss}\n`;
                });
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `æˆ‘çš„åˆ†æ•¸ç´€éŒ„_${new Date().toLocaleDateString()}.csv`;
            link.click();
            showToast("æª”æ¡ˆå·²ç¶“å­˜å¥½å›‰ï¼");
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split(/\r?\n/);
                    const newData = {};
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',');
                        if (cols.length < 4) continue;
                        const date = cols[0];
                        if (!newData[date]) newData[date] = { fortunePosition: cols[1], players: [] };
                        newData[date].players.push({ name: cols[2], win: parseInt(cols[3]) > 0 ? parseInt(cols[3]) : 0, loss: parseInt(cols[3]) < 0 ? Math.abs(parseInt(cols[3])) : 0 });
                    }
                    mahjongData = { ...mahjongData, ...newData };
                    localStorage.setItem('mahjong_2026_elderly', JSON.stringify(mahjongData));
                    init();
                    showToast("èˆŠè³‡æ–™è®€å–æˆåŠŸï¼");
                } catch (err) { showToast("è®€å–å¤±æ•—"); }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
