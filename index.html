<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ§§ 2026 é˜¿åœŸä¼¯ (GitHub éƒ¨ç½²ç‰ˆ)</title>
    
    <!-- ä½¿ç”¨ Tailwind CSS é€²è¡Œæ’ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap');
        
        :root {
            --primary-red: #cc0000;
            --dark-gold: #b38600;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fffaf0;
            color: #1a1a1a;
            margin: 0;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
        }

        /* é–å®šç•«é¢æ¨£å¼ï¼šé©—è­‰æˆåŠŸå‰é¡¯ç¤º */
        #authBarrier {
            position: fixed;
            inset: 0;
            background: #cc0000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .festive-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 3px solid #ff0000;
        }

        .btn-large {
            background-color: var(--primary-red);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 900;
            text-align: center;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 0 #800000;
            display: block;
            width: 100%;
        }

        .btn-google {
            background-color: white;
            color: #444;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: 2px solid #ddd;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-gold-large {
            background-color: #ffcc00;
            color: #332200;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 900;
            text-align: center;
            border: 2px solid #b38600;
            box-shadow: 0 4px 0 #b38600;
            display: block;
            width: 100%;
        }

        .calendar-day {
            aspect-ratio: 1.1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 700;
            background: #fdfdfd;
            border: 2px solid #eee;
            position: relative;
        }

        .calendar-day.selected {
            background: var(--primary-red);
            color: white;
            border-color: #800000;
        }

        .calendar-day.has-data::after {
            content: 'â—';
            color: #ffcc00;
            position: absolute;
            bottom: 2px;
            font-size: 14px;
        }

        input, select {
            border: 3px solid #cccccc;
            border-radius: 10px;
            padding: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            width: 100%;
            background: white;
        }

        .big-label {
            font-size: 1.1rem;
            font-weight: 900;
            color: #333;
            margin-bottom: 6px;
            display: block;
        }

        #importInput { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- é©—è­‰ç‰† -->
    <div id="authBarrier">
        <div class="festive-card p-8 max-w-sm w-full text-center">
            <h2 class="text-3xl font-black text-red-700 mb-6">é˜¿åœŸä¼¯ ç³»çµ±å…¥å£</h2>
            
            <div id="configError" class="hidden mb-6 bg-yellow-100 p-4 rounded-xl border-2 border-yellow-500 text-left">
                <p class="font-bold text-yellow-800">âš ï¸ è¨­å®šæœ‰èª¤</p>
                <p id="configErrorMessage" class="text-xs text-yellow-700 mt-2">è«‹ç¢ºèªæ‚¨çš„ API Key èˆ‡ Firebase è¨­å®šã€‚</p>
            </div>

            <div id="authLoading" class="mb-4 text-white font-bold bg-black/20 p-2 rounded text-sm">æ­£åœ¨è®€å–é©—è­‰æ¨¡çµ„...</div>
            
            <div id="loginSection" class="hidden">
                <p class="text-lg font-bold mb-6 text-gray-600">è«‹ä½¿ç”¨æŒ‡å®šçš„ Gmail ç™»å…¥</p>
                <button onclick="loginWithGoogle()" class="btn-google">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24">
                    ä½¿ç”¨ Google ç™»å…¥
                </button>
                <p class="mt-4 text-[10px] text-red-100 italic">* å»ºè­°ä½¿ç”¨ Safari æˆ– Chrome é–‹å•Ÿ</p>
            </div>

            <div id="accessDenied" class="hidden">
                <p class="text-xl font-black text-red-600 mb-4">ğŸš« æ¬Šé™ä¸è¶³</p>
                <p id="deniedEmail" class="text-gray-500 mb-6 break-all text-sm font-bold"></p>
                <button onclick="logout()" class="btn-large">åˆ‡æ›å¸³è™Ÿ</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç¨‹å¼ä»‹é¢ -->
    <div id="mainContent" class="hidden">
        <div class="max-w-4xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="text-center md:text-left">
                    <h1 class="text-3xl md:text-5xl font-black text-red-700 mb-1">ğŸ§§ 2026 é˜¿åœŸä¼¯</h1>
                    <p class="text-lg text-red-500 font-bold">å­—é«”åŠ å¤§ãƒ»ç°¡å–®å¥½ç”¨</p>
                </div>
                <div class="flex items-center gap-3 bg-white p-2 rounded-full shadow-sm border border-red-100">
                    <span id="userDisplay" class="text-sm font-bold text-gray-600 px-3 border-r border-gray-100"></span>
                    <button onclick="logout()" class="px-3 py-1 text-xs font-bold text-red-400 hover:text-red-600 transition-colors">ç™»å‡º</button>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-5 space-y-8">
                    <!-- ç¬¬ä¸€æ­¥ï¼šé¸æ—¥æœŸ -->
                    <div class="festive-card p-6">
                        <h2 class="text-xl font-black text-center mb-4 text-red-800">ç¬¬ä¸€æ­¥ï¼šé¸æ—¥æœŸ</h2>
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="changeMonth(-1)" class="bg-gray-200 p-4 rounded-full text-2xl font-black leading-none">â®</button>
                            <h2 id="currentMonthDisplay" class="text-2xl font-black">2026å¹´ 1æœˆ</h2>
                            <button onclick="changeMonth(1)" class="bg-gray-200 p-4 rounded-full text-2xl font-black leading-none">â¯</button>
                        </div>
                        <div class="grid grid-cols-7 gap-3 text-center text-sm font-black text-red-600 mb-2">
                            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-3"></div>
                    </div>

                    <!-- æ’è¡Œæ¦œ -->
                    <div class="festive-card p-6">
                        <h3 class="text-2xl font-black mb-4 flex items-center text-red-700 border-b-4 border-red-100 pb-2">
                            ğŸ† ç¸½æ’è¡Œæ¦œ
                        </h3>
                        <div id="overallStatsList" class="space-y-3">
                            <p class="text-center text-gray-500 py-4">å°šç„¡å¾æˆ°ç´€éŒ„</p>
                        </div>
                    </div>

                    <!-- è³‡æ–™å‚™ä»½ -->
                    <div class="festive-card p-6 space-y-4">
                        <h3 class="text-xl font-black text-center mb-2">ğŸ’¾ è³‡æ–™ç®¡ç†</h3>
                        <button onclick="exportToCSV()" class="btn-gold-large">åŒ¯å‡ºæ‰‹æ©Ÿå‚™ä»½ (CSV)</button>
                        <button onclick="document.getElementById('importInput').click()" class="text-lg font-bold w-full p-4 border-2 border-dashed border-gray-400 rounded-xl text-gray-600">è®€å–èˆŠè³‡æ–™</button>
                        <input type="file" id="importInput" accept=".csv" onchange="importFromCSV(event)">
                    </div>
                </div>

                <div class="md:col-span-7">
                    <!-- ç¬¬äºŒæ­¥ï¼šå¡«å¯«å…§å®¹ -->
                    <div class="festive-card p-6 md:p-8">
                        <div class="flex justify-between items-center mb-8 border-b-8 border-red-50 pb-6">
                            <div>
                                <span class="text-lg font-bold text-gray-500">æ­£åœ¨è¼¸å…¥ï¼š</span>
                                <h2 class="text-4xl font-black text-red-600" id="selectedDateDisplay">2026-01-01</h2>
                            </div>
                            <div id="balanceBadge" class="p-3 rounded-xl text-lg font-black bg-gray-200 text-gray-600 shadow-inner">
                                æœªç®—å¸³
                            </div>
                        </div>

                        <div class="mb-8">
                            <label class="big-label">ğŸ§§ ä»Šæ—¥è²¡ä½</label>
                            <select id="fortunePosition" class="cursor-pointer">
                                <option value="">--- è«‹é¸æ“‡ ---</option>
                                <option value="çª—é‚Š">çª—é‚Š</option>
                                <option value="é›»è¦–">é›»è¦–</option>
                                <option value="æ²™ç™¼">æ²™ç™¼</option>
                                <option value="å®¢å»³">å®¢å»³</option>
                            </select>
                        </div>

                        <div class="mb-8">
                            <h3 class="big-label border-l-8 border-red-600 pl-3 mb-4">å¡«å…¥è´(+)/è¼¸(-)åˆ†æ•¸</h3>
                            <div class="overflow-hidden border-2 border-gray-100 rounded-xl shadow-sm">
                                <table class="w-full text-left">
                                    <thead class="bg-red-50">
                                        <tr class="text-lg font-black">
                                            <th class="p-4 text-red-800">ç©å®¶</th>
                                            <th class="p-4 text-center text-red-800">åˆ†æ•¸</th>
                                            <th class="p-4 text-right text-red-800">å°è¨ˆ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="playerTableBody" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="text-lg text-red-600 font-black text-center" id="errorMsg">
                                â€» ç¸½å’Œéœ€ç‚º 0 ä¸”é¸å¥½è²¡ä½å–”ï¼
                            </div>
                            <button id="saveBtn" onclick="saveData()" class="btn-large">
                                ğŸ€„ ç¢ºèªå­˜æª” (ç™¼å¤§è²¡ï¼)
                            </button>
                            <button onclick="clearForm()" class="text-lg font-bold text-gray-400 w-full py-4 underline">
                                æ¸…é™¤ä»Šæ—¥ç´€éŒ„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast è¨Šæ¯æç¤º -->
    <div id="toast" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 px-10 py-6 rounded-2xl bg-black/90 text-white text-2xl font-black opacity-0 transition-opacity pointer-events-none z-50 shadow-2xl"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase è¨­å®šï¼šè«‹å‹™å¿…åœ¨æ­¤å¡«å…¥æ‚¨åœ¨ Firebase Console çœ‹åˆ°çš„ã€ŒWeb API é‡‘é‘°ã€ ---
        const firebaseConfig = {
            apiKey: "AIzaSyCl3EvTjBYU2SUSTdapfayKVyfH4aFe7Tc", // è«‹ç¢ºä¿æ­¤è™•é‡‘é‘°æ­£ç¢º
            authDomain: "richman-6a91a.firebaseapp.com",
            projectId: "richman-6a91a",
            storageBucket: "richman-6a91a.firebasestorage.app",
            messagingSenderId: "759410355663",
            appId: "1:759410355663:web:08d17f99f9772d1f0af6ba"
        };

        const ALLOWED_EMAILS = [
            "alexl.051906@gmail.com", 
            "yachin2010@gmail.com"
        ];

        // åˆå§‹åŒ– Firebase
        let configToUse = firebaseConfig;
        try {
            // å¦‚æœåœ¨ Gemini çš„é è¦½ç’°å¢ƒï¼Œå˜—è©¦è®€å–æ³¨å…¥çš„è®Šæ•¸
            if (typeof __firebase_config !== 'undefined') {
                configToUse = JSON.parse(__firebase_config);
            }
        } catch (e) {}

        const app = initializeApp(configToUse);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // å…¬é–‹çš„å…¨åŸŸç™»å…¥å‡½æ•¸
        window.loginWithGoogle = async () => {
            try {
                await signInWithRedirect(auth, provider);
            } catch (error) {
                console.error("Login initiation failed", error);
                alert("å•Ÿå‹•ç™»å…¥å¤±æ•—: " + error.message);
            }
        };

        // å…¬é–‹çš„å…¨åŸŸç™»å‡ºå‡½æ•¸
        window.logout = () => {
            signOut(auth).then(() => {
                location.reload();
            });
        };

        // è™•ç† Redirect å›å‚³çµæœ
        async function checkRedirect() {
            try {
                const result = await getRedirectResult(auth);
                if (result && result.user) {
                    console.log("å°å‘ç™»å…¥æˆåŠŸ:", result.user.email);
                }
            } catch (err) {
                console.error("Redirect Result Error", err);
                if (err.message.includes("requested action is invalid")) {
                    document.getElementById('configError').classList.remove('hidden');
                    document.getElementById('configErrorMessage').innerText = "âš ï¸ éŒ¯èª¤ï¼šFirebase æ‹’çµ•å­˜å–ã€‚è«‹ç¢ºèªæ‚¨çš„ GitHub ç¶²åŸŸ (alexdotlin.github.io) å·²åœ¨ Firebase Console çš„ã€Œæˆæ¬Šç¶²åŸŸã€æ¸…å–®ä¸­ï¼Œä¸” API Key æ­£ç¢ºã€‚";
                }
            }
        }

        // ç›£è½ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
            const loading = document.getElementById('authLoading');
            const loginSection = document.getElementById('loginSection');
            const accessDenied = document.getElementById('accessDenied');
            const mainContent = document.getElementById('mainContent');
            const authBarrier = document.getElementById('authBarrier');

            if (loading) loading.classList.add('hidden');

            if (user) {
                if (ALLOWED_EMAILS.includes(user.email)) {
                    // é©—è­‰é€šéï¼šéš±è—é©—è­‰ç‰†ï¼Œé¡¯ç¤ºä¸»ç¨‹å¼
                    authBarrier.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    document.getElementById('userDisplay').innerText = user.displayName || user.email;
                    initAppLogic(); 
                } else {
                    // å¸³è™Ÿä¸ç¬¦ï¼šé¡¯ç¤ºæ¬Šé™ä¸è¶³
                    loginSection.classList.add('hidden');
                    accessDenied.classList.remove('hidden');
                    document.getElementById('deniedEmail').innerText = user.email;
                    authBarrier.style.display = 'flex';
                }
            } else {
                // æœªç™»å…¥ï¼šé¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                loginSection.classList.remove('hidden');
                accessDenied.classList.add('hidden');
                mainContent.classList.add('hidden');
                authBarrier.style.display = 'flex';
            }
        });

        checkRedirect();

        // --- éº»å°‡è¨ˆåˆ†ç¨‹å¼é‚è¼¯ ---
        let currentYear = 2026;
        let currentMonth = new Date().getMonth();
        let selectedDate = new Date().toISOString().split('T')[0];
        const FIXED_PLAYERS = ["WKC", "Alex", "JayDeep", "Molly", "Yachin"];
        let mahjongData = JSON.parse(localStorage.getItem('mahjong_2026_v2')) || {};

        function initAppLogic() {
            renderPlayerRows();
            renderCalendar();
            selectDate(selectedDate);
            updateOverallStats();
        }

        function renderPlayerRows() {
            const tbody = document.getElementById('playerTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const name = FIXED_PLAYERS[i] || "å…¶ä»–";
                tbody.innerHTML += `
                    <tr>
                        <td class="p-4 font-bold text-gray-700">
                            ${name}
                            <input type="hidden" class="player-name" value="${name}">
                        </td>
                        <td class="p-4">
                            <input type="number" class="net-input text-center text-2xl font-black w-full bg-gray-50 rounded-lg py-2" placeholder="0">
                        </td>
                        <td class="p-4 text-right text-2xl font-black row-total text-gray-300">0</td>
                    </tr>
                `;
            }
            document.querySelectorAll('.net-input').forEach(input => {
                input.addEventListener('input', calculateDailyTotal);
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const display = document.getElementById('currentMonthDisplay');
            if (!grid) return;
            grid.innerHTML = '';
            const date = new Date(currentYear, currentMonth, 1);
            display.innerText = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
            const firstDay = date.getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isSelected = dateStr === selectedDate;
                const hasData = mahjongData[dateStr] ? 'has-data' : '';
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day ${isSelected ? 'selected' : ''} ${hasData}`;
                dayEl.innerText = day;
                dayEl.onclick = () => selectDate(dateStr);
                grid.appendChild(dayEl);
            }
        }

        // åˆ‡æ›æœˆä»½
        window.changeMonth = (delta) => {
            currentMonth += delta;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        };

        // é¸å–æ—¥æœŸ
        window.selectDate = (dateStr) => {
            selectedDate = dateStr;
            const display = document.getElementById('selectedDateDisplay');
            if (display) display.innerText = dateStr;
            renderCalendar();
            const rows = document.querySelectorAll('#playerTableBody tr');
            if (mahjongData[dateStr]) {
                const data = mahjongData[dateStr];
                document.getElementById('fortunePosition').value = data.fortunePosition || "";
                data.players.forEach((p, i) => {
                    if (rows[i]) {
                        rows[i].querySelector('.net-input').value = (p.win - p.loss) || 0;
                    }
                });
            } else {
                document.querySelectorAll('.net-input').forEach(i => i.value = "");
                document.getElementById('fortunePosition').value = '';
            }
            calculateDailyTotal();
        };

        // è¨ˆç®—æ¯æ—¥ç¸½å’Œ
        function calculateDailyTotal() {
            const rows = document.querySelectorAll('#playerTableBody tr');
            let grandTotal = 0;
            rows.forEach(row => {
                const val = parseInt(row.querySelector('.net-input').value) || 0;
                const el = row.querySelector('.row-total');
                el.innerText = (val >= 0 ? '+' : '') + val;
                el.className = `p-4 text-right text-2xl font-black row-total ${val > 0 ? 'text-green-600' : (val < 0 ? 'text-red-600' : 'text-gray-300')}`;
                grandTotal += val;
            });
            const badge = document.getElementById('balanceBadge');
            if (badge) {
                if (grandTotal === 0) {
                    badge.innerText = "âœ… å¸³ç›®æ­£ç¢º";
                    badge.className = "p-3 rounded-xl text-lg font-black bg-green-500 text-white shadow-lg animate-bounce";
                } else {
                    badge.innerText = `âŒ å·®äº† ${grandTotal}`;
                    badge.className = "p-3 rounded-xl text-lg font-black bg-gray-200 text-gray-600";
                }
            }
        }

        // å„²å­˜è³‡æ–™
        window.saveData = () => {
            const fortune = document.getElementById('fortunePosition').value;
            if (!fortune) { alert("è«‹é¸æ“‡è²¡ä½ï¼"); return; }
            const rows = document.querySelectorAll('#playerTableBody tr');
            let grandTotal = 0;
            const players = [];
            rows.forEach(row => {
                const name = row.querySelector('.player-name').value;
                const val = parseInt(row.querySelector('.net-input').value) || 0;
                players.push({ name, win: val > 0 ? val : 0, loss: val < 0 ? Math.abs(val) : 0 });
                grandTotal += val;
            });
            if (grandTotal !== 0) { alert("å¸³ç›®ä¸å°å–”ï¼ç›®å‰èª¤å·®ï¼š" + grandTotal); return; }
            mahjongData[selectedDate] = { fortunePosition: fortune, players: players };
            localStorage.setItem('mahjong_2026_v2', JSON.stringify(mahjongData));
            updateOverallStats();
            renderCalendar();
            alert("å·²æˆåŠŸå­˜æª”ï¼ç™¼è²¡å•¦ï¼");
        };

        // æ¸…é™¤è³‡æ–™
        window.clearForm = () => {
            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å¤©çš„ç´€éŒ„å—ï¼Ÿ")) {
                delete mahjongData[selectedDate];
                localStorage.setItem('mahjong_2026_v2', JSON.stringify(mahjongData));
                selectDate(selectedDate);
                updateOverallStats();
            }
        };

        // æ›´æ–°ç¸½æ’è¡Œæ¦œ
        function updateOverallStats() {
            const totals = {};
            Object.values(mahjongData).forEach(day => {
                day.players.forEach(p => {
                    if (!totals[p.name]) totals[p.name] = { net: 0 };
                    totals[p.name].net += (p.win - p.loss);
                });
            });
            const sorted = Object.entries(totals).sort((a, b) => b[1].net - a[1].net);
            const list = document.getElementById('overallStatsList');
            if (!list) return;
            if (sorted.length === 0) { list.innerHTML = '<p class="text-center text-gray-500 py-4">ç›®å‰å°šç„¡æ•¸æ“š</p>'; return; }
            list.innerHTML = sorted.map(([name, data], index) => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border-2 border-gray-200 shadow-sm">
                    <div class="flex items-center gap-4">
                        <span class="text-xl w-8 h-8 flex items-center justify-center rounded-full ${index === 0 ? 'bg-yellow-400 text-white' : 'bg-gray-200 text-gray-500'} font-black">${index+1}</span>
                        <span class="text-2xl font-black">${name}</span>
                    </div>
                    <div class="font-black text-2xl ${data.net >= 0 ? 'text-green-600' : 'text-red-600'}">${data.net >= 0 ? '+' : ''}${data.net}</div>
                </div>
            `).join('');
        }

        // åŒ¯å‡º CSV
        window.exportToCSV = () => {
            if (Object.keys(mahjongData).length === 0) { alert("å°šæœªæœ‰è³‡æ–™å¯ä¾›åŒ¯å‡ºã€‚"); return; }
            let csvContent = "\ufeffæ—¥æœŸ,è²¡ä½,ç©å®¶,åˆ†æ•¸\n";
            Object.keys(mahjongData).sort().forEach(date => {
                const d = mahjongData[date];
                d.players.forEach(p => {
                    csvContent += `${date},${d.fortunePosition},${p.name},${p.win - p.loss}\n`;
                });
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `é˜¿åœŸä¼¯ç´€éŒ„_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };

        // åŒ¯å…¥ CSV
        window.importFromCSV = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split(/\r?\n/);
                    const newData = {};
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',');
                        if (cols.length < 4) continue;
                        const date = cols[0];
                        if (!newData[date]) newData[date] = { fortunePosition: cols[1], players: [] };
                        const val = parseInt(cols[3]);
                        newData[date].players.push({ name: cols[2], win: val > 0 ? val : 0, loss: val < 0 ? Math.abs(val) : 0 });
                    }
                    if (confirm("å·²è§£æè³‡æ–™ï¼Œç¢ºå®šè¦è¦†è“‹æˆ–åˆä½µç¾æœ‰ç´€éŒ„ï¼Ÿ")) {
                        mahjongData = { ...mahjongData, ...newData };
                        localStorage.setItem('mahjong_2026_v2', JSON.stringify(mahjongData));
                        initAppLogic();
                    }
                } catch (err) { alert("è§£æå¤±æ•—ï¼Œè«‹ç¢ºèª CSV æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚"); }
            };
            reader.readAsText(file);
        };
    </script>
</body>
</html>
